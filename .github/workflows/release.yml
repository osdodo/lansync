name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive_name: linux-x86_64

          # macOS x86_64
          - target: x86_64-apple-darwin
            os: macos-latest
            archive_name: macos-x86_64

          # macOS ARM64 (Apple Silicon)
          - target: aarch64-apple-darwin
            os: macos-latest
            archive_name: macos-aarch64

          # Windows x86_64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive_name: windows-x86_64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install system dependencies (Linux native)
      if: matrix.target == 'x86_64-unknown-linux-gnu'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.target }}-
          ${{ runner.os }}-cargo-

    - name: Build release (Linux native with static OpenSSL)
      if: matrix.target == 'x86_64-unknown-linux-gnu'
      env:
        OPENSSL_STATIC: 1
      run: cargo build --release --target ${{ matrix.target }}

    - name: Build release (other platforms)
      if: matrix.os != 'ubuntu-latest'
      run: cargo build --release --target ${{ matrix.target }}

    - name: Get version
      id: version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          VERSION="v${VERSION}-dev"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Create release package (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        cd target/${{ matrix.target }}/release
        BINARY_NAME="lansync"
        VERSION="${{ steps.version.outputs.version }}"
        RELEASE_DIR="lansync-${VERSION}-${{ matrix.archive_name }}"
        
        mkdir -p "$RELEASE_DIR"
        cp "$BINARY_NAME" "$RELEASE_DIR/"
        
        tar -czf "${RELEASE_DIR}.tar.gz" "$RELEASE_DIR"
        
        echo "ARCHIVE_FILE=${RELEASE_DIR}.tar.gz" >> $GITHUB_ENV
        echo "ARCHIVE_PATH=target/${{ matrix.target }}/release/${RELEASE_DIR}.tar.gz" >> $GITHUB_ENV

    - name: Create release package (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        cd target/${{ matrix.target }}/release
        $BINARY_NAME = "lansync.exe"
        $VERSION = "${{ steps.version.outputs.version }}"
        $RELEASE_DIR = "lansync-$VERSION-${{ matrix.archive_name }}"

        # Clean up any existing files
        if (Test-Path $RELEASE_DIR) {
          Remove-Item -Path $RELEASE_DIR -Recurse -Force
        }
        if (Test-Path "${RELEASE_DIR}.zip") {
          Remove-Item -Path "${RELEASE_DIR}.zip" -Force
        }

        New-Item -ItemType Directory -Path $RELEASE_DIR -Force
        Copy-Item $BINARY_NAME -Destination "$RELEASE_DIR/"

        Compress-Archive -Path $RELEASE_DIR -DestinationPath "${RELEASE_DIR}.zip" -Force

        echo "ARCHIVE_FILE=${RELEASE_DIR}.zip" >> $env:GITHUB_ENV
        echo "ARCHIVE_PATH=target/${{ matrix.target }}/release/${RELEASE_DIR}.zip" >> $env:GITHUB_ENV

    - name: Generate SHA256 checksum (Unix)
      if: runner.os != 'Windows'
      run: |
        cd target/${{ matrix.target }}/release
        sha256sum "${{ env.ARCHIVE_FILE }}" > "${{ env.ARCHIVE_FILE }}.sha256"

    - name: Generate SHA256 checksum (Windows)
      if: runner.os == 'Windows'
      run: |
        cd target/${{ matrix.target }}/release
        Get-FileHash -Algorithm SHA256 "${{ env.ARCHIVE_FILE }}" | ForEach-Object { "$($_.Hash.ToLower())  $($_.Path | Split-Path -Leaf)" } > "${{ env.ARCHIVE_FILE }}.sha256"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lansync-${{ matrix.archive_name }}
        path: |
          ${{ env.ARCHIVE_PATH }}
          ${{ env.ARCHIVE_PATH }}.sha256

